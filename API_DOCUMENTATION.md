# API Documentation

## Base URL

```
http://localhost:8000/api
```

## Authentication

Currently, the API is public. For production, consider implementing authentication middleware.

### n8n Callback Authentication

The callback endpoint (`POST /api/ad-scripts/{id}/result`) requires an API key in the `X-N8N-API-KEY` header:

```bash
X-N8N-API-KEY: your-api-key-here
```

## Endpoints

### 1. Create Ad Script Task

**Endpoint:** `POST /api/ad-scripts`

**Description:** Creates a new ad script task and queues it for processing by n8n AI Agent.

**Request Body:**
```json
{
  "reference_script": "Your original advertising script here...",
  "outcome_description": "Make it more engaging and target young adults aged 18-25."
}
```

**Response:** `201 Created`
```json
{
  "data": {
    "id": 1,
    "reference_script": "...",
    "outcome_description": "...",
    "new_script": null,
    "analysis": null,
    "status": "pending",
    "created_at": "2025-12-09T12:00:00+00:00",
    "updated_at": "2025-12-09T12:00:00+00:00"
  }
}
```

**Validation Rules:**
- `reference_script`: required, string, minimum 10 characters
- `outcome_description`: required, string, minimum 10 characters

**Rate Limit:** 60 requests per minute

---

### 2. Get Task Details

**Endpoint:** `GET /api/ad-scripts/{id}`

**Description:** Retrieves details of a specific ad script task.

**Response:** `200 OK`
```json
{
  "task": {
    "id": 1,
    "reference_script": "...",
    "outcome_description": "...",
    "new_script": "Improved script...",
    "analysis": "Analysis of changes...",
    "status": "completed",
    "error_details": null,
    "created_at": "2025-12-09T12:00:00+00:00",
    "updated_at": "2025-12-09T12:05:00+00:00",
    "processing_time": 300
  }
}
```

**Status Codes:**
- `200`: Task found
- `404`: Task not found

---

### 3. List All Tasks

**Endpoint:** `GET /api/ad-scripts`

**Description:** Lists all ad script tasks with pagination.

**Query Parameters:**
- `per_page` (optional): Number of items per page (default: 15, max: 100)
- `status` (optional): Filter by status (`pending`, `completed`, `failed`)
- `search` (optional): Search in reference_script and outcome_description

**Example:** `GET /api/ad-scripts?per_page=20&status=completed&search=marketing`

**Response:** `200 OK`
```json
{
  "data": [
    {
      "id": 1,
      "reference_script": "...",
      "outcome_description": "...",
      "status": "completed",
      "created_at": "2025-12-09T12:00:00+00:00",
      "updated_at": "2025-12-09T12:05:00+00:00"
    }
  ],
  "links": {
    "first": "http://localhost:8000/api/ad-scripts?page=1",
    "last": "http://localhost:8000/api/ad-scripts?page=10",
    "prev": null,
    "next": "http://localhost:8000/api/ad-scripts?page=2"
  },
  "meta": {
    "current_page": 1,
    "from": 1,
    "last_page": 10,
    "per_page": 15,
    "to": 15,
    "total": 150
  }
}
```

---

### 4. Update Task Result (Callback)

**Endpoint:** `POST /api/ad-scripts/{id}/result`

**Description:** Callback endpoint used by n8n to update task results. This endpoint requires authentication via `X-N8N-API-KEY` header.

**Headers:**
```
X-N8N-API-KEY: your-api-key-here
Content-Type: application/json
```

**Request Body:**
```json
{
  "new_script": "Improved script generated by AI...",
  "analysis": "Analysis of changes made..."
}
```

**Response:** `200 OK`
```json
{
  "message": "Task result updated successfully",
  "task": {
    "id": 1,
    "status": "completed",
    "new_script": "...",
    "analysis": "..."
  }
}
```

**Status Codes:**
- `200`: Success
- `401`: Unauthorized (invalid API key)
- `404`: Task not found
- `409`: Task already completed
- `422`: Validation error

---

### 5. Health Check

**Endpoint:** `GET /api/ad-scripts/health`

**Description:** Returns health status and statistics.

**Response:** `200 OK`
```json
{
  "status": "healthy",
  "database": "connected",
  "statistics": {
    "pending": 5,
    "completed": 120,
    "failed": 3,
    "total": 128
  },
  "timestamp": "2025-12-09T12:00:00+00:00"
}
```

---

## Task Statuses

- **pending**: Task created, waiting for n8n processing
- **completed**: Task successfully processed by n8n
- **failed**: Task failed during processing

## Error Responses

### Validation Error (422)
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "reference_script": [
      "The reference script field must be at least 10 characters."
    ]
  }
}
```

### Not Found (404)
```json
{
  "message": "No query results for model [App\\Models\\AdScriptTask] 999"
}
```

### Unauthorized (401)
```json
{
  "message": "Unauthorized",
  "error": "Invalid API key"
}
```

### Rate Limit Exceeded (429)
```json
{
  "message": "Too Many Attempts."
}
```

## Rate Limiting

- **Create Task**: 60 requests per minute per IP
- **Other endpoints**: No rate limit (consider adding for production)

## Best Practices

1. **Polling**: Instead of polling, consider using webhooks or real-time updates
2. **Error Handling**: Always check the `status` field before accessing `new_script` or `analysis`
3. **Retry Logic**: Implement exponential backoff for failed requests
4. **Timeout**: n8n processing may take up to 2 minutes, plan accordingly

## Example cURL Requests

### Create Task
```bash
curl -X POST http://localhost:8000/api/ad-scripts \
  -H "Content-Type: application/json" \
  -d '{
    "reference_script": "Buy our product now! Limited time offer!",
    "outcome_description": "Make it professional for B2B audience"
  }'
```

### Get Task
```bash
curl http://localhost:8000/api/ad-scripts/1
```

### List Tasks
```bash
curl "http://localhost:8000/api/ad-scripts?status=completed&per_page=10"
```

### Health Check
```bash
curl http://localhost:8000/api/ad-scripts/health
```

